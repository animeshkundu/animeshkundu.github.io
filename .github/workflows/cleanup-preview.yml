name: Cleanup Preview Deployment

on:
  delete:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch'
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Extract branch name and remove preview
        run: |
          # Get the deleted branch name
          BRANCH_NAME="${{ github.event.ref }}"
          
          # Sanitize branch name for URL (replace slashes and special chars with hyphens)
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          # Create the deployment path with test- prefix
          DEPLOY_PATH="test-${SANITIZED_BRANCH}"
          
          echo "Cleaning up preview deployment at: ${DEPLOY_PATH}"
          
          # Check if the directory exists
          if [ -d "${DEPLOY_PATH}" ]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            
            git rm -rf "${DEPLOY_PATH}"
            git commit -m "Clean up preview deployment for deleted branch: ${BRANCH_NAME}"
            git push origin gh-pages
            
            echo "::notice::Removed preview deployment at /${DEPLOY_PATH}/"
          else
            echo "::notice::No preview deployment found at /${DEPLOY_PATH}/"
          fi
